format_version: "13"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
    - BITRISE_STEP_ID: mise
    - BITRISE_STEP_VERSION: "0.1.0"
    - BITRISE_STEP_GIT_CLONE_URL: https://github.com/kexi/bitrise-step-mise.git
    - MY_STEPLIB_REPO_FORK_GIT_URL: $MY_STEPLIB_REPO_FORK_GIT_URL

workflows:
  test:
    title: Run all tests
    before_run:
      - test_default
      - test_specific_version
      - test_skip_trust_install
      - test_with_config

  test_default:
    title: Test with default settings
    steps:
      - path::./:
          title: Install mise with defaults
          inputs:
            - mise_version: latest
            - run_trust: "yes"
            - run_install: "yes"
            - use_shims: "yes"
      - script:
          title: Verify mise installation
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Check mise is available
                mise --version

                # Check environment variables
                echo "MISE_BIN_PATH: ${MISE_BIN_PATH}"
                echo "MISE_SHIMS_PATH: ${MISE_SHIMS_PATH}"

                # Verify paths exist
                test -f "${MISE_BIN_PATH}"
                test -d "${MISE_SHIMS_PATH}"

                echo "Default installation test passed!"

  test_specific_version:
    title: Test with specific version
    steps:
      - path::./:
          title: Install mise v2024.1.0
          inputs:
            - mise_version: "v2024.1.0"
            - run_trust: "no"
            - run_install: "no"
            - use_shims: "yes"
      - script:
          title: Verify specific version
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Check mise version
                mise --version | grep "2024.1.0"

                echo "Specific version test passed!"

  test_skip_trust_install:
    title: Test skipping trust and install
    steps:
      - path::./:
          title: Install mise without trust/install
          inputs:
            - mise_version: latest
            - run_trust: "no"
            - run_install: "no"
            - use_shims: "no"
      - script:
          title: Verify mise is installed but no tools
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Check mise is available
                mise --version

                # Verify shims not in PATH (since use_shims=no)
                # This is a basic check - in real scenario PATH wouldn't include shims

                echo "Skip trust/install test passed!"

  test_with_config:
    title: Test with mise.toml config
    steps:
      - script:
          title: Create test mise.toml
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Create a test mise.toml
                cat > mise.toml << 'EOF'
                [tools]
                node = "20"
                EOF

                cat mise.toml
      - path::./:
          title: Install mise and tools from config
          inputs:
            - mise_version: latest
            - run_trust: "yes"
            - run_install: "yes"
            - use_shims: "yes"
      - script:
          title: Verify Node.js is installed
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Check Node.js is available via shims
                node --version

                # Verify it's Node 20.x
                node --version | grep "v20"

                echo "Config test passed!"
      - script:
          title: Cleanup
          inputs:
            - content: |
                #!/bin/bash
                rm -f mise.toml

  audit-this-step:
    title: Audit this step
    steps:
      - script:
          title: Audit step.yml
          inputs:
            - content: |
                #!/bin/bash
                set -ex
                stepman audit --step-yml ./step.yml
